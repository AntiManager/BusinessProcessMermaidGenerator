# excel_exporter.py
"""
–≠–∫—Å–ø–æ—Ä—Ç —Ä–µ–µ—Å—Ç—Ä–æ–≤ –≤ Excel —Ñ–æ—Ä–º–∞—Ç –¥–ª—è –¥–∞–ª—å–Ω–µ–π—à–µ–≥–æ –∞–Ω–∞–ª–∏–∑–∞ –∏ –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
–°–ø–µ—Ü–∏–∞–ª—å–Ω–æ –∞–¥–∞–ø—Ç–∏—Ä–æ–≤–∞–Ω –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –∫–∞–∫ –∏—Å—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
"""
import pandas as pd
from pathlib import Path
from typing import Dict, List, Set, Optional
from models import Operation, AnalysisData, CausalAnalysis, CausalLink
from utils import safe_id
from config import ENCODING

def export_operations_registry(operations: Dict[str, Operation], 
                             original_columns: List[str],
                             output_file: Path) -> None:
    """
    –≠–∫—Å–ø–æ—Ä—Ç —Ä–µ–µ—Å—Ç—Ä–∞ –æ–ø–µ—Ä–∞—Ü–∏–π –≤ —Ñ–æ—Ä–º–∞—Ç–µ –ü–†–ò–ì–û–î–ù–û–ú –î–õ–Ø –ü–û–í–¢–û–†–ù–û–ì–û –ò–°–ü–û–õ–¨–ó–û–í–ê–ù–ò–Ø
    –∫–∞–∫ –∏—Å—Ö–æ–¥–Ω—ã–π —Ñ–∞–π–ª –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –¥–∏–∞–≥—Ä–∞–º–º –±–∏–∑–Ω–µ—Å-–ø—Ä–æ—Ü–µ—Å—Å–æ–≤
    """
    data = []
    
    for op_name, op in operations.items():
        # –§–æ—Ä–º–∏—Ä—É–µ–º —Å—Ç—Ä–æ–∫—É –≤ –¢–û–ß–ù–û–ú –§–û–†–ú–ê–¢–ï –∏—Å—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
        row = {
            '–û–ø–µ—Ä–∞—Ü–∏—è': op_name,
            '–í—Ö–æ–¥—ã': '; '.join(op.inputs) if op.inputs else '',
            '–í—ã—Ö–æ–¥': '; '.join(op.outputs) if op.outputs else '',
        }
        
        # –î–æ–±–∞–≤–ª—è–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –º–µ—Ç–∞-–ø–æ–ª—è –µ—Å–ª–∏ –æ–Ω–∏ –µ—Å—Ç—å
        if op.group:
            row['–ì—Ä—É–ø–ø–∞'] = op.group
        if op.owner:
            row['–í–ª–∞–¥–µ–ª–µ—Ü'] = op.owner
        if op.detailed:
            row['–ü–æ–¥—Ä–æ–±–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏'] = op.detailed
        if op.subgroup:
            row['–ü–æ–¥–≥—Ä—É–ø–ø–∞'] = op.subgroup
        
        # –ù–û–í–û–ï: –î–æ–±–∞–≤–ª—è–µ–º –º–µ—Ç—Ä–∏–∫–∏ –ø–æ—Ç–æ–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Ü–µ–Ω–Ω–æ—Å—Ç–∏
        if op.time_minutes > 0:
            row['–í—Ä–µ–º—è –æ–ø–µ—Ä–∞—Ü–∏–∏ (–º–∏–Ω)'] = op.time_minutes
        if op.cycle_count > 0:
            row['–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ü–∏–∫–ª–æ–≤'] = op.cycle_count
        if op.cycle_period:
            row['–ü–µ—Ä–∏–æ–¥ —Ü–∏–∫–ª–∞'] = op.cycle_period
        if op.personnel_count > 0:
            row['–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–µ—Ä—Å–æ–Ω–∞–ª–∞'] = op.personnel_count
        if op.personnel_cost_per_hour > 0:
            row['–°—Ç–æ–∏–º–æ—Å—Ç—å —á–∞—Å–∞ —Ä–∞–±–æ—Ç—ã (—Ä—É–±)'] = op.personnel_cost_per_hour
        
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –í–°–ï –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è –∏–∑ –∏—Å—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
        if hasattr(op, 'additional_data') and op.additional_data:
            for key, value in op.additional_data.items():
                # –ò–∑–±–µ–≥–∞–µ–º –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã—Ö –ø–æ–ª–µ–π
                if key not in ['–û–ø–µ—Ä–∞—Ü–∏—è', '–í—Ö–æ–¥—ã', '–í—ã—Ö–æ–¥', '–ì—Ä—É–ø–ø–∞', '–í–ª–∞–¥–µ–ª–µ—Ü', '–ü–æ–¥—Ä–æ–±–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏', '–ü–æ–¥–≥—Ä—É–ø–ø–∞',
                              '–í—Ä–µ–º—è –æ–ø–µ—Ä–∞—Ü–∏–∏ (–º–∏–Ω)', '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ü–∏–∫–ª–æ–≤', '–ü–µ—Ä–∏–æ–¥ —Ü–∏–∫–ª–∞', '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–µ—Ä—Å–æ–Ω–∞–ª–∞', '–°—Ç–æ–∏–º–æ—Å—Ç—å —á–∞—Å–∞ —Ä–∞–±–æ—Ç—ã (—Ä—É–±)']:
                    row[key] = value
        
        data.append(row)
    
    # –°–æ–∑–¥–∞–µ–º DataFrame —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º –ø–æ—Ä—è–¥–∫–æ–º –∫–æ–ª–æ–Ω–æ–∫
    # –ü–µ—Ä–≤—ã–µ –∫–æ–ª–æ–Ω–∫–∏ - –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –¥–ª—è –±–∏–∑–Ω–µ—Å-–ø—Ä–æ—Ü–µ—Å—Å–æ–≤
    base_columns = ['–û–ø–µ—Ä–∞—Ü–∏—è', '–í—Ö–æ–¥—ã', '–í—ã—Ö–æ–¥']
    
    # –ó–∞—Ç–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –º–µ—Ç–∞-–∫–æ–ª–æ–Ω–∫–∏ (–µ—Å–ª–∏ –æ–Ω–∏ –±—ã–ª–∏ –≤ –∏—Å—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö)
    meta_columns = []
    for col in ['–ì—Ä—É–ø–ø–∞', '–í–ª–∞–¥–µ–ª–µ—Ü', '–ü–æ–¥—Ä–æ–±–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏', '–ü–æ–¥–≥—Ä—É–ø–ø–∞']:
        if any(row.get(col) for row in data):
            meta_columns.append(col)
    
    # –ó–∞—Ç–µ–º –º–µ—Ç—Ä–∏–∫–∏ –ø–æ—Ç–æ–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Ü–µ–Ω–Ω–æ—Å—Ç–∏
    value_stream_columns = []
    for col in ['–í—Ä–µ–º—è –æ–ø–µ—Ä–∞—Ü–∏–∏ (–º–∏–Ω)', '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ü–∏–∫–ª–æ–≤', '–ü–µ—Ä–∏–æ–¥ —Ü–∏–∫–ª–∞', '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–µ—Ä—Å–æ–Ω–∞–ª–∞', '–°—Ç–æ–∏–º–æ—Å—Ç—å —á–∞—Å–∞ —Ä–∞–±–æ—Ç—ã (—Ä—É–±)']:
        if any(row.get(col) for row in data):
            value_stream_columns.append(col)
    
    # –ó–∞—Ç–µ–º –≤—Å–µ –æ—Å—Ç–∞–ª—å–Ω—ã–µ –∫–æ–ª–æ–Ω–∫–∏ –≤ –∞–ª—Ñ–∞–≤–∏—Ç–Ω–æ–º –ø–æ—Ä—è–¥–∫–µ
    other_columns = sorted(set().union(*(row.keys() for row in data)) - 
                          set(base_columns) - set(meta_columns) - set(value_stream_columns))
    
    all_columns = base_columns + meta_columns + value_stream_columns + other_columns
    
    df = pd.DataFrame(data)
    
    # –£–±–µ–¥–∏–º—Å—è —á—Ç–æ –≤—Å–µ –∫–æ–ª–æ–Ω–∫–∏ –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É—é—Ç (–¥–∞–∂–µ –µ—Å–ª–∏ –ø—É—Å—Ç—ã–µ)
    for col in all_columns:
        if col not in df.columns:
            df[col] = ''
    
    # –ü–µ—Ä–µ—É–ø–æ—Ä—è–¥–æ—á–∏–≤–∞–µ–º –∫–æ–ª–æ–Ω–∫–∏
    df = df[all_columns]
    
    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ Excel
    with pd.ExcelWriter(output_file, mode='w', engine='openpyxl') as writer:
        df.to_excel(writer, sheet_name='–†–µ–µ—Å—Ç—Ä_–æ–ø–µ—Ä–∞—Ü–∏–π_–ë–ü', index=False)

def export_value_stream_analysis(operations: Dict[str, Operation], output_file: Path) -> None:
    """
    –ù–û–í–ê–Ø –§–£–ù–ö–¶–ò–Ø: –≠–∫—Å–ø–æ—Ä—Ç –∞–Ω–∞–ª–∏–∑–∞ –ø–æ—Ç–æ–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Ü–µ–Ω–Ω–æ—Å—Ç–∏
    """
    data = []
    
    for op_name, op in operations.items():
        total_time = op.total_time_per_period
        total_cost = op.total_personnel_cost_per_period
        
        # –†–∞—Å—á–µ—Ç —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
        efficiency = ""
        if total_time > 0 and total_cost > 0:
            if total_cost / total_time < 10:  # –£—Å–ª–æ–≤–Ω—ã–π –ø–æ–∫–∞–∑–∞—Ç–µ–ª—å
                efficiency = "–í—ã—Å–æ–∫–∞—è"
            elif total_cost / total_time < 50:
                efficiency = "–°—Ä–µ–¥–Ω—è—è"
            else:
                efficiency = "–ù–∏–∑–∫–∞—è"
        
        row = {
            '–û–ø–µ—Ä–∞—Ü–∏—è': op_name,
            '–í—Ä–µ–º—è –æ–ø–µ—Ä–∞—Ü–∏–∏ (–º–∏–Ω)': op.time_minutes,
            '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ü–∏–∫–ª–æ–≤': op.cycle_count,
            '–ü–µ—Ä–∏–æ–¥ —Ü–∏–∫–ª–∞': op.cycle_period,
            '–û–±—â–µ–µ –≤—Ä–µ–º—è –∑–∞ –ø–µ—Ä–∏–æ–¥ (–º–∏–Ω)': total_time,
            '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–µ—Ä—Å–æ–Ω–∞–ª–∞': op.personnel_count,
            '–°—Ç–æ–∏–º–æ—Å—Ç—å —á–∞—Å–∞ (—Ä—É–±)': op.personnel_cost_per_hour,
            '–û–±—â–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å –∑–∞ –ø–µ—Ä–∏–æ–¥ (—Ä—É–±)': total_cost,
            '–≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å': efficiency,
            '–ì—Ä—É–ø–ø–∞': op.group,
            '–í–ª–∞–¥–µ–ª–µ—Ü': op.owner
        }
        data.append(row)
    
    df = pd.DataFrame(data)
    
    # –î–æ–±–∞–≤–ª—è–µ–º –≤ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π —Ñ–∞–π–ª
    with pd.ExcelWriter(output_file, mode='a', engine='openpyxl', if_sheet_exists='replace') as writer:
        df.to_excel(writer, sheet_name='–ê–Ω–∞–ª–∏–∑_–ø–æ—Ç–æ–∫–∞_—Ü–µ–Ω–Ω–æ—Å—Ç–∏', index=False)

def export_io_registry(analysis_data: AnalysisData, output_file: Path) -> None:
    """
    –≠–∫—Å–ø–æ—Ä—Ç —Ä–µ–µ—Å—Ç—Ä–∞ –≤—Ö–æ–¥–æ–≤/–≤—ã—Ö–æ–¥–æ–≤ –¥–ª—è —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞ –ø–æ—Ç–æ–∫–æ–≤
    –∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–∑–∞—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö
    """
    external_inputs = analysis_data.external_inputs
    final_outputs = analysis_data.final_outputs
    output_to_operation = analysis_data.output_to_operation
    input_to_operations = analysis_data.input_to_operations
    
    data = []
    items = external_inputs | final_outputs | set(output_to_operation.keys()) | set(input_to_operations.keys())
    
    for item in sorted(items):
        if not item:
            continue
            
        # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø —ç–ª–µ–º–µ–Ω—Ç–∞
        if item in external_inputs:
            element_type = "–í–Ω–µ—à–Ω–∏–π –≤—Ö–æ–¥"
        elif item in final_outputs:
            element_type = "–ö–æ–Ω–µ—á–Ω—ã–π –≤—ã—Ö–æ–¥"
        else:
            element_type = "–ü—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã–π"
            
        # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∏—Å—Ç–æ—á–Ω–∏–∫
        source = "–í–Ω–µ—à–Ω–∏–π" if item in external_inputs else output_to_operation.get(item, "")
        
        # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª–µ–π
        consumers = input_to_operations.get(item, [])
        
        row = {
            '–≠–ª–µ–º–µ–Ω—Ç': item,
            '–¢–∏–ø': element_type,
            '–ò—Å—Ç–æ—á–Ω–∏–∫': source,
            '–ü–æ—Ç—Ä–µ–±–∏—Ç–µ–ª–∏': '; '.join(consumers) if consumers else '',
            '–ö–∞—Ç–µ–≥–æ—Ä–∏—è_–¥–∞–Ω–Ω—ã—Ö': '',  # –î–ª—è —Ä—É—á–Ω–æ–≥–æ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è: –º–∞—Ç–µ—Ä–∏–∞–ª—å–Ω—ã–µ, –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω—ã–µ, —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–µ
            '–ö—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç—å': '',       # –í—ã—Å–æ–∫–∞—è/–°—Ä–µ–¥–Ω—è—è/–ù–∏–∑–∫–∞—è
            '–ü—Ä–∏–º–µ—á–∞–Ω–∏—è': ''
        }
        data.append(row)
    
    df = pd.DataFrame(data)
    
    # –î–æ–±–∞–≤–ª—è–µ–º –≤ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π —Ñ–∞–π–ª
    with pd.ExcelWriter(output_file, mode='a', engine='openpyxl', if_sheet_exists='replace') as writer:
        df.to_excel(writer, sheet_name='–†–µ–µ—Å—Ç—Ä_–≤—Ö–æ–¥–æ–≤_–≤—ã—Ö–æ–¥–æ–≤', index=False)

def export_cld_registry(causal_analysis: Optional[CausalAnalysis], output_file: Path) -> None:
    """
    –≠–∫—Å–ø–æ—Ä—Ç —Ä–µ–µ—Å—Ç—Ä–∞ –ø—Ä–∏—á–∏–Ω–Ω–æ-—Å–ª–µ–¥—Å—Ç–≤–µ–Ω–Ω—ã—Ö —Å–≤—è–∑–µ–π –≤ —Ñ–æ—Ä–º–∞—Ç–µ –ü–†–ò–ì–û–î–ù–û–ú 
    –¥–ª—è –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –∫–∞–∫ –∏—Å—Ö–æ–¥–Ω—ã–π —Ñ–∞–π–ª –¥–ª—è CLD
    –í–°–ï–ì–î–ê —Å–æ–∑–¥–∞–µ—Ç —Ä–µ–µ—Å—Ç—Ä, –¥–∞–∂–µ –µ—Å–ª–∏ causal_analysis –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç
    """
    links_data = []
    
    if causal_analysis and causal_analysis.links:
        # –ï—Å—Ç—å –¥–∞–Ω–Ω—ã–µ CLD - —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Å–≤—è–∑–∏
        for link in causal_analysis.links:
            # –§–æ—Ä–º–∏—Ä—É–µ–º —Å—Ç—Ä–æ–∫—É –≤ —Ñ–æ—Ä–º–∞—Ç–µ –∏—Å—Ö–æ–¥–Ω—ã—Ö CLD –¥–∞–Ω–Ω—ã—Ö
            link_row = {
                '–ò—Å—Ç–æ—á–Ω–∏–∫': link.source,
                '–¶–µ–ª—å': link.target,
                '–ó–Ω–∞–∫ –≤–ª–∏—è–Ω–∏—è': link.influence,
            }
            
            # –î–æ–±–∞–≤–ª—è–µ–º –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è –µ—Å–ª–∏ –æ–Ω–∏ –µ—Å—Ç—å
            if link.strength:
                link_row['–°–∏–ª–∞ –≤–ª–∏—è–Ω–∏—è'] = link.strength
            if link.operation:
                link_row['–û–ø–µ—Ä–∞—Ü–∏—è'] = link.operation
            if link.description:
                link_row['–û–ø–∏—Å–∞–Ω–∏–µ'] = link.description
            
            link_row['–£—á–∏—Ç—ã–≤–∞—Ç—å –≤ CLD'] = '–î–∞' if link.include_in_cld else '–ù–µ—Ç'
            link_row['–ö–∞—Ç–µ–≥–æ—Ä–∏—è —Å–≤—è–∑–∏'] = ''  # –î–ª—è —Ä—É—á–Ω–æ–≥–æ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è
            
            links_data.append(link_row)
    else:
        # –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö CLD - —Å–æ–∑–¥–∞–µ–º —à–∞–±–ª–æ–Ω —Å –ø—Ä–∏–º–µ—Ä–∞–º–∏
        examples = [
            {
                '–ò—Å—Ç–æ—á–Ω–∏–∫': '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–ª–∏–µ–Ω—Ç–æ–≤',
                '–¶–µ–ª—å': '–í—ã—Ä—É—á–∫–∞',
                '–ó–Ω–∞–∫ –≤–ª–∏—è–Ω–∏—è': '+',
                '–û–ø–µ—Ä–∞—Ü–∏—è': '–ü—Ä–æ–¥–∞–∂–∞ —Ç–æ–≤–∞—Ä–æ–≤',
                '–û–ø–∏—Å–∞–Ω–∏–µ': '–ß–µ–º –±–æ–ª—å—à–µ –∫–ª–∏–µ–Ω—Ç–æ–≤, —Ç–µ–º –≤—ã—à–µ –≤—ã—Ä—É—á–∫–∞'
            },
            {
                '–ò—Å—Ç–æ—á–Ω–∏–∫': '–¶–µ–Ω–∞ —Ç–æ–≤–∞—Ä–∞', 
                '–¶–µ–ª—å': '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–ª–∏–µ–Ω—Ç–æ–≤',
                '–ó–Ω–∞–∫ –≤–ª–∏—è–Ω–∏—è': '-',
                '–û–ø–µ—Ä–∞—Ü–∏—è': '–£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ü–µ–Ω—ã',
                '–û–ø–∏—Å–∞–Ω–∏–µ': '–†–æ—Å—Ç —Ü–µ–Ω—ã —Å–Ω–∏–∂–∞–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–ª–∏–µ–Ω—Ç–æ–≤'
            },
            {
                '–ò—Å—Ç–æ—á–Ω–∏–∫': '–ö–∞—á–µ—Å—Ç–≤–æ –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏—è',
                '–¶–µ–ª—å': '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–ª–∏–µ–Ω—Ç–æ–≤', 
                '–ó–Ω–∞–∫ –≤–ª–∏—è–Ω–∏—è': '+',
                '–û–ø–µ—Ä–∞—Ü–∏—è': '–û–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç–æ–≤',
                '–û–ø–∏—Å–∞–Ω–∏–µ': '–£–ª—É—á—à–µ–Ω–∏–µ –∫–∞—á–µ—Å—Ç–≤–∞ –ø—Ä–∏–≤–ª–µ–∫–∞–µ—Ç –±–æ–ª—å—à–µ –∫–ª–∏–µ–Ω—Ç–æ–≤'
            }
        ]
        links_data = examples

    # –°–æ–∑–¥–∞–µ–º DataFrame
    links_df = pd.DataFrame(links_data)
    
    # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ø–æ—Ä—è–¥–æ–∫ –∫–æ–ª–æ–Ω–æ–∫ –¥–ª—è —Å–≤—è–∑–µ–π (–∫–∞–∫ –≤ –∏—Å—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö)
    link_base_columns = ['–ò—Å—Ç–æ—á–Ω–∏–∫', '–¶–µ–ª—å', '–ó–Ω–∞–∫ –≤–ª–∏—è–Ω–∏—è']
    link_other_columns = sorted(set(links_df.columns) - set(link_base_columns))
    links_df = links_df[link_base_columns + link_other_columns]
    
    # –î–æ–±–∞–≤–ª—è–µ–º –≤ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π —Ñ–∞–π–ª
    with pd.ExcelWriter(output_file, mode='a', engine='openpyxl', if_sheet_exists='replace') as writer:
        links_df.to_excel(writer, sheet_name='CLD_–°–≤—è–∑–∏', index=False)

def export_complete_registry(operations: Dict[str, Operation],
                           analysis_data: AnalysisData,
                           causal_analysis: Optional[CausalAnalysis],
                           original_columns: List[str],
                           output_base: str,
                           output_dir: Path = None) -> Path:
    """
    –ü–æ–ª–Ω—ã–π —ç–∫—Å–ø–æ—Ä—Ç –í–°–ï–• —Ä–µ–µ—Å—Ç—Ä–æ–≤ –≤ –æ–¥–∏–Ω Excel —Ñ–∞–π–ª
    –¢–µ–ø–µ—Ä—å causal_analysis –≤—Å–µ–≥–¥–∞ –¥–æ–ª–∂–µ–Ω –ø–µ—Ä–µ–¥–∞–≤–∞—Ç—å—Å—è –¥–ª—è –±–∏–∑–Ω–µ—Å-–ø—Ä–æ—Ü–µ—Å—Å–æ–≤
    """
    if output_dir is None:
        output_dir = Path(".")
    
    output_file = output_dir / f"{output_base}_—Ä–µ–µ—Å—Ç—Ä—ã_–¥–ª—è_–ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è.xlsx"
    
    # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø —ç–∫—Å–ø–æ—Ä—Ç–∞
    has_cld_data = causal_analysis and causal_analysis.links
    export_type = "–ø–æ–ª–Ω—ã–π –∫–æ–º–ø–ª–µ–∫—Ç" if has_cld_data else "–∫–æ–º–ø–ª–µ–∫—Ç (CLD - —à–∞–±–ª–æ–Ω –¥–ª—è –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è)"
    
    # –í–°–ï–ì–î–ê —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º –≤—Å–µ —Ä–µ–µ—Å—Ç—Ä—ã:
    
    # 1. –†–µ–µ—Å—Ç—Ä –æ–ø–µ—Ä–∞—Ü–∏–π –±–∏–∑–Ω–µ—Å-–ø—Ä–æ—Ü–µ—Å—Å–æ–≤
    export_operations_registry(operations, original_columns, output_file)
    
    # 2. –ù–û–í–´–ô: –ê–Ω–∞–ª–∏–∑ –ø–æ—Ç–æ–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Ü–µ–Ω–Ω–æ—Å—Ç–∏
    export_value_stream_analysis(operations, output_file)
    
    # 3. –†–µ–µ—Å—Ç—Ä –≤—Ö–æ–¥–æ–≤/–≤—ã—Ö–æ–¥–æ–≤  
    export_io_registry(analysis_data, output_file)
    
    # 4. –†–µ–µ—Å—Ç—Ä CLD —Å–≤—è–∑–µ–π
    export_cld_registry(causal_analysis, output_file)
    
    # –î–û–ë–ê–í–õ–Ø–ï–ú –ò–ù–°–¢–†–£–ö–¶–ò–Æ –ü–û –ü–ï–†–ï–ò–°–ü–û–õ–¨–ó–û–í–ê–ù–ò–Æ
    with pd.ExcelWriter(output_file, mode='a', engine='openpyxl', if_sheet_exists='replace') as writer:
        instructions_data = [
            ['üéØ –ò–ù–°–¢–†–£–ö–¶–ò–Ø –ü–û –ü–ï–†–ï–ò–°–ü–û–õ–¨–ó–û–í–ê–ù–ò–Æ –†–ï–ï–°–¢–†–û–í', ''],
            ['', ''],
            ['üìã –†–ï–ï–°–¢–† –û–ü–ï–†–ê–¶–ò–ô (–ª–∏—Å—Ç "–†–µ–µ—Å—Ç—Ä_–æ–ø–µ—Ä–∞—Ü–∏–π_–ë–ü")', ''],
            ['‚Ä¢ –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:', '–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∫–∞–∫ –ò–°–•–û–î–ù–´–ô –§–ê–ô–õ –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –Ω–æ–≤—ã—Ö –¥–∏–∞–≥—Ä–∞–º–º –±–∏–∑–Ω–µ—Å-–ø—Ä–æ—Ü–µ—Å—Å–æ–≤'],
            ['‚Ä¢ –§–æ—Ä–º–∞—Ç:', '–¢–æ—á–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –∏—Å—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö - –º–æ–∂–Ω–æ —Å—Ä–∞–∑—É –∑–∞–≥—Ä—É–∂–∞—Ç—å –≤ –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä'],
            ['‚Ä¢ –ß—Ç–æ –¥–µ–ª–∞—Ç—å:', '1. –î–æ–ø–æ–ª–Ω—è–π—Ç–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ 2. –î–æ–±–∞–≤–ª—è–π—Ç–µ –Ω–æ–≤—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ 3. –ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É–π—Ç–µ —Å–≤—è–∑–∏'],
            ['', ''],
            ['üìä –ê–ù–ê–õ–ò–ó –ü–û–¢–û–ö–ê –¶–ï–ù–ù–û–°–¢–ò (–ª–∏—Å—Ç "–ê–Ω–∞–ª–∏–∑_–ø–æ—Ç–æ–∫–∞_—Ü–µ–Ω–Ω–æ—Å—Ç–∏")', ''],
            ['‚Ä¢ –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:', '–†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π –∞–Ω–∞–ª–∏–∑ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –æ–ø–µ—Ä–∞—Ü–∏–π –ø–æ —Å–∏—Å—Ç–µ–º–µ –ø–æ—Ç–æ–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Ü–µ–Ω–Ω–æ—Å—Ç–∏'],
            ['‚Ä¢ –ú–µ—Ç—Ä–∏–∫–∏:', '–í—Ä–µ–º—è –æ–ø–µ—Ä–∞—Ü–∏–π, —Å—Ç–æ–∏–º–æ—Å—Ç—å, —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å, —Ä–∞—Å—á–µ—Ç—ã –ø–æ –ø–µ—Ä–∏–æ–¥–∞–º'],
            ['‚Ä¢ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:', '–î–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ –∏ —Å–Ω–∏–∂–µ–Ω–∏—è –∏–∑–¥–µ—Ä–∂–µ–∫'],
            ['', ''],
            ['üîÑ –†–ï–ï–°–¢–† CLD (–ª–∏—Å—Ç "CLD_–°–≤—è–∑–∏")', ''],
            ['‚Ä¢ –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:', '–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∫–∞–∫ –ò–°–•–û–î–ù–´–ô –§–ê–ô–õ –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ Causal Loop Diagrams'],
            ['‚Ä¢ –ò—Å—Ç–æ—á–Ω–∏–∫ –¥–∞–Ω–Ω—ã—Ö:', '–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ—Å—Ç—Ä–æ–µ–Ω –∏–∑ –≤—Ö–æ–¥–æ–≤/–≤—ã—Ö–æ–¥–æ–≤ –±–∏–∑–Ω–µ—Å-–ø—Ä–æ—Ü–µ—Å—Å–æ–≤'],
            ['‚Ä¢ –§–æ—Ä–º–∞—Ç:', '–¢–æ—á–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–ª—è —Ä—É—á–Ω–æ–≥–æ –≤–≤–æ–¥–∞ CLD –¥–∞–Ω–Ω—ã—Ö'],
            ['‚Ä¢ –ß—Ç–æ –¥–µ–ª–∞—Ç—å:', '1. –î–æ–ø–æ–ª–Ω—è–π—Ç–µ —Å–≤—è–∑–∏ 2. –î–æ–±–∞–≤–ª—è–π—Ç–µ –Ω–æ–≤—ã–µ —Å–≤—è–∑–∏ 3. –£—Ç–æ—á–Ω—è–π—Ç–µ –∑–Ω–∞–∫–∏ –≤–ª–∏—è–Ω–∏—è'],
            ['', ''],
            ['üìä –†–ï–ï–°–¢–† –í–•–û–î–û–í/–í–´–•–û–î–û–í (–ª–∏—Å—Ç "–†–µ–µ—Å—Ç—Ä_–≤—Ö–æ–¥–æ–≤_–≤—ã—Ö–æ–¥–æ–≤")', ''],
            ['‚Ä¢ –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:', '–†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –ø–æ—Ç–æ–∫–æ–≤ –¥–∞–Ω–Ω—ã—Ö –∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–∑–∞—Ü–∏—è'],
            ['‚Ä¢ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:', '–î–ª—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∏, –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏–∏ –∏ –≤—ã—è–≤–ª–µ–Ω–∏—è —É–∑–∫–∏—Ö –º–µ—Å—Ç'],
            ['', ''],
            ['üöÄ –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò –ü–û –†–ê–ë–û–¢–ï:', ''],
            ['1. –°–û–•–†–ê–ù–ò–¢–ï –ò–°–•–û–î–ù–´–ô –§–ê–ô–õ', '–°–æ–∑–¥–∞–π—Ç–µ –∫–æ–ø–∏—é –ø–µ—Ä–µ–¥ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ–º'],
            ['2. –î–û–ü–û–õ–ù–Ø–ô–¢–ï –ü–û–°–¢–ï–ü–ï–ù–ù–û', '–î–æ–±–∞–≤–ª—è–π—Ç–µ –ø–æ 5-10 –æ–ø–µ—Ä–∞—Ü–∏–π –∑–∞ —Ä–∞–∑ –∏ –ø—Ä–æ–≤–µ—Ä—è–π—Ç–µ –¥–∏–∞–≥—Ä–∞–º–º—ã'],
            ['3. –ò–°–ü–û–õ–¨–ó–£–ô–¢–ï –ö–ê–¢–ï–ì–û–†–ò–ò', '–ó–∞–ø–æ–ª–Ω—è–π—Ç–µ –∫–æ–ª–æ–Ω–∫–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–π –¥–ª—è –ª—É—á—à–µ–≥–æ –∞–Ω–∞–ª–∏–∑–∞'],
            ['4. –°–õ–ï–î–£–ô–¢–ï –§–û–†–ú–ê–¢–£', '–°–æ—Ö—Ä–∞–Ω—è–π—Ç–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—É –∫–æ–ª–æ–Ω–æ–∫ –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏'],
            ['5. –í–ê–õ–ò–î–ò–†–£–ô–¢–ï –°–í–Ø–ó–ò', '–ü—Ä–æ–≤–µ—Ä—è–π—Ç–µ —á—Ç–æ –≤—Ö–æ–¥—ã/–≤—ã—Ö–æ–¥—ã –ø—Ä–∞–≤–∏–ª—å–Ω–æ —Å–≤—è–∑–∞–Ω—ã'],
        ]
        
        instructions_df = pd.DataFrame(instructions_data, columns=['–≠–ª–µ–º–µ–Ω—Ç', '–û–ø–∏—Å–∞–Ω–∏–µ'])
        instructions_df.to_excel(writer, sheet_name='üìñ–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è', index=False)
    
    print(f"\n" + "="*70)
    print(f"‚úÖ {export_type.upper()} –†–ï–ï–°–¢–†–û–í –î–õ–Ø –ü–ï–†–ï–ò–°–ü–û–õ–¨–ó–û–í–ê–ù–ò–Ø –°–û–ó–î–ê–ù!")
    print("="*70)
    print(f"üìÅ –§–∞–π–ª: {output_file}")
    print("\nüìä –°–û–î–ï–†–ñ–ê–ù–ò–ï:")
    print("   ‚Ä¢ üìã –†–µ–µ—Å—Ç—Ä –æ–ø–µ—Ä–∞—Ü–∏–π –ë–ü - –≥–æ—Ç–æ–≤ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é –∫–∞–∫ –∏—Å—Ö–æ–¥–Ω–∏–∫")
    print("   ‚Ä¢ üìà –ê–Ω–∞–ª–∏–∑ –ø–æ—Ç–æ–∫–∞ —Ü–µ–Ω–Ω–æ—Å—Ç–∏ - –º–µ—Ç—Ä–∏–∫–∏ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –æ–ø–µ—Ä–∞—Ü–∏–π")
    print("   ‚Ä¢ üîÑ –†–µ–µ—Å—Ç—Ä CLD —Å–≤—è–∑–µ–π - " + ("–∞–≤—Ç–æ –∏–∑ –±–∏–∑–Ω–µ—Å-–ø—Ä–æ—Ü–µ—Å—Å–æ–≤" if has_cld_data else "—à–∞–±–ª–æ–Ω –¥–ª—è –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è"))
    print("   ‚Ä¢ üìä –†–µ–µ—Å—Ç—Ä –≤—Ö–æ–¥–æ–≤/–≤—ã—Ö–æ–¥–æ–≤ - –∞–Ω–∞–ª–∏–∑ –ø–æ—Ç–æ–∫–æ–≤ –¥–∞–Ω–Ω—ã—Ö")
    print("   ‚Ä¢ üìñ –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è - —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é")
    
    if not has_cld_data:
        print("\nüí° –°–û–í–ï–¢: –î–ª—è –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è CLD —Ä–µ–µ—Å—Ç—Ä–∞:")
        print("   - –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ñ–æ—Ä–º–∞—Ç: –ò—Å—Ç–æ—á–Ω–∏–∫ ‚Üí –¶–µ–ª—å ‚Üí –ó–Ω–∞–∫ –≤–ª–∏—è–Ω–∏—è (+)")
        print("   - –î–æ–±–∞–≤—å—Ç–µ —Å–≤—è–∑–∏ –º–µ–∂–¥—É –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–º–∏ –∏–∑ –±–∏–∑–Ω–µ—Å-–ø—Ä–æ—Ü–µ—Å—Å–æ–≤")
        print("   - –ü—Ä–∏–º–µ—Ä: '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–∫–∞–∑–æ–≤' ‚Üí '–ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–∞' ‚Üí '+'")
    
    return output_file

def export_lightweight_registry(operations: Dict[str, Operation],
                              analysis_data: AnalysisData,
                              original_columns: List[str],
                              output_base: str,
                              output_dir: Path = None) -> Path:
    """
    –û–±–ª–µ–≥—á–µ–Ω–Ω—ã–π —ç–∫—Å–ø–æ—Ä—Ç –¢–û–õ–¨–ö–û —Ä–µ–µ—Å—Ç—Ä–∞ –æ–ø–µ—Ä–∞—Ü–∏–π –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
    """
    if output_dir is None:
        output_dir = Path(".")
    
    output_file = output_dir / f"{output_base}_–æ–ø–µ—Ä–∞—Ü–∏–∏_—à–∞–±–ª–æ–Ω.xlsx"
    
    # –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º —Ç–æ–ª—å–∫–æ –æ–ø–µ—Ä–∞—Ü–∏–∏
    export_operations_registry(operations, original_columns, output_file)
    
    print(f"\n" + "="*60)
    print("‚úÖ –®–ê–ë–õ–û–ù –û–ü–ï–†–ê–¶–ò–ô –î–õ–Ø –ü–ï–†–ï–ò–°–ü–û–õ–¨–ó–û–í–ê–ù–ò–Ø –°–û–ó–î–ê–ù!")
    print("="*60)
    print(f"üìÅ –§–∞–π–ª: {output_file}")
    print("\nüéØ –ò–°–ü–û–õ–¨–ó–û–í–ê–ù–ò–ï:")
    print("   ‚Ä¢ –†–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ —ç—Ç–æ—Ç —Ñ–∞–π–ª –≤ Excel")
    print("   ‚Ä¢ –î–æ–±–∞–≤–ª—è–π—Ç–µ –Ω–æ–≤—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –∏ —Å–≤—è–∑–∏") 
    print("   ‚Ä¢ –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–∞–∫ –∏—Å—Ö–æ–¥–Ω—ã–π —Ñ–∞–π–ª –≤ –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä–µ –¥–∏–∞–≥—Ä–∞–º–º")
    print("   ‚Ä¢ –°–æ—Ö—Ä–∞–Ω—è–π—Ç–µ —Ñ–æ—Ä–º–∞—Ç –∫–æ–ª–æ–Ω–æ–∫ –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏")
    
    return output_file